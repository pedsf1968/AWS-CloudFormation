---
AWSTemplateFormatVersion: "2010-09-09"
Description:  This template VPC Endpoint Service for NLB or GLB

Parameters:
  # Global parameters
  Bucket:
    Default: "hawkfund-cloudformation"
    Description: CloudFormation buket URL
    Type: String
  BucketKey:
    Default: ""
    Description: Key to find object in the bucket
    Type: String
  BucketObject:
    Default: "Data.json"
    Description: "File to store data in the bucket"
    Type: String
  EnvironmentName:
    AllowedValues: ["dev", "test", "staging", "prod"]
    ConstraintDescription: "Must specify dev, test or prod"
    Default: "dev"
    Description: "Environment name that prefix all resources"
    Type: String    
  ProjectName:
    Default: "ANS"
    Description: "Project name that prefix all resources"
    Type: String
  SaveInS3File:
    AllowedValues: [ "false", "true" ]
    Default: "false"
    Description: "Save resources information in s3 file"
    Type: String

  # Stack parameters
  PolicyDocument:
    Description: |
      An endpoint policy, which controls access to the service from the VPC. The default endpoint policy allows full access to the service. Endpoint policies are supported only for gateway and interface endpoints.
    Type: String
  PrivateDnsEnabled:
    AllowedValues: [ "true", "false" ]
    Default: "false"
    Description: |
      Indicate whether to associate a private hosted zone with the specified VPC. The private hosted zone contains a record set for the default public DNS name for the service for the Region (for example, kinesis.us-east-1.amazonaws.com), which resolves to the private IP addresses of the endpoint network interfaces in the VPC. This enables you to make requests to the default public DNS name for the service instead of the public DNS names that are automatically generated by the VPC endpoint service.
    Type: String
  RouteTableId:
    Default: ""
    Description: The ID of the route tables. Routing is supported only for gateway endpoints.
    Type: String
  ServiceName:
    Description: "The name of the endpoint service."
    Type: String
  SecurityGroupId:
    Description: "The Security Group for VPC Endpoint."
    Type: String
  SubnetId:
    Type: String
  VpcId:
    Type: String
  VpcEndpointType:
    Description: "The type of endpoint."
    Type: String
    Default: "Gateway"
    AllowedValues:
      - "Interface"
      - "Gateway"
      - "GatewayLoadBalancer"

Conditions:
  isGatewayType: !Equals [ !Ref VpcEndpointType, "Gateway"]
  isGatewayLoadBalancerType: !Equals [ !Ref VpcEndpointType, "GatewayLoadBalancer"]
  isInterfaceType: !Equals [ !Ref VpcEndpointType, "Interface"]
  SaveInS3File: !Equals [ !Ref SaveInS3File, "true"]
  

Resources:
  VpcEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      PolicyDocument: !Ref PolicyDocument
      PrivateDnsEnabled: !Ref PrivateDnsEnabled
      RouteTableIds: !If 
        - isGatewayType
        - [!Ref RouteTableId]
        - !Ref AWS::NoValue
      SecurityGroupIds: !If
        - isInterfaceType
        - [!Ref SecurityGroupId]
        - !Ref AWS::NoValue
      ServiceName: !Ref ServiceName
      SubnetIds: !If 
        - isGatewayType
        - !Ref AWS::NoValue
        - [!Ref SubnetId]
      Tags:
        - Key: EnvironmentName
          Value: !Ref EnvironmentName
        - Key: Name
          Value: !Sub "${ProjectName}-${EnvironmentName}-VPCE"
        - Key: ManagedBy
          Value: "CloudFormation"
        - Key: ProjectName
          Value: !Ref ProjectName
      VpcEndpointType: !Ref VpcEndpointType
      VpcId: !Ref VpcId

  VpcEndpointToS3:
    Type: AWS::CloudFormation::CustomResource
    Condition: SaveInS3File
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      ServiceToken: !Join [ ":", [ "arn:aws:lambda", !Sub "${AWS::Region}", !Sub "${AWS::AccountId}", "function:EC2ResourceToS3"]]
      ServiceTimeout: 60
      Bucket: !Ref Bucket
      BucketKey: !Ref BucketKey
      BucketObject: !Ref BucketObject
      Region: !Ref AWS::Region
      ResourceType: "VpcEndpoint"
      Key: !Sub "${AWS::Region}:${ProjectName}:${EnvironmentName}:EC2:VPCEndpoint:${VpcEndpointType}"
      Value: !Ref VpcEndpoint

Outputs:
  VpcEndpointId:
    Description: "Returns the ID of the VPC endpoint."
    Value: !Ref VpcEndpoint