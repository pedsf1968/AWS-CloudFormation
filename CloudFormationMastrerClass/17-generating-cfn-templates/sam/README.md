# Initialise on CloudShell
## Help
```
[cloudshell-user@ip-10-6-60-46 ~]$ sam
Usage: sam [OPTIONS] COMMAND [ARGS]...

  AWS Serverless Application Model (SAM) CLI

  The AWS Serverless Application Model Command Line Interface (AWS SAM CLI) is
  a command line tool that you can use with AWS SAM templates and supported
  third-party integrations to build and run your serverless applications.

  Learn more: https://docs.aws.amazon.com/serverless-application-model/

Commands:

  Learn:
    docs NEW!           Launch the AWS SAM CLI documentation in a browser.

  Create an App:
    init                Initialize an AWS SAM application.

  Develop your App:
    build               Build your AWS serverless function code.
    local               Run your AWS serverless function locally.
    validate            Validate an AWS SAM template.
    sync NEW!           Sync an AWS SAM project to AWS.
    remote NEW!         Invoke or send an event to cloud resources in your AWS
                        Cloudformation stack.

  Deploy your App:
    package             Package an AWS SAM application.
    deploy              Deploy an AWS SAM application.

  Monitor your App:
    logs                Fetch AWS Cloudwatch logs for AWS Lambda Functions or
                        Cloudwatch Log groups.
    traces              Fetch AWS X-Ray traces.

  And More:
    list NEW!           Fetch the state of your AWS serverless application.
    delete              Delete an AWS SAM application and the artifacts created
                        by sam deploy.
    pipeline            Manage the continuous delivery of your AWS serverless
                        application.
    publish             Publish a packaged AWS SAM template to AWS Serverless
                        Application Repository for easy sharing.

Options:
                                    
    --beta-features / --no-beta-features
                                    Enable/Disable beta features.
    --debug                         Turn on debug logging to print debug message
                                    generated by AWS SAM CLI and display
                                    timestamps.
    --version                       Show the version and exit.
    --info                          Show system and dependencies information.
    -h, --help                      Show this message and exit.

Examples:
                        
    Get Started:        $sam init
```
## SAM Initialisation
```
[cloudshell-user@ip-10-6-60-46 ~]$ sam init

        SAM CLI now collects telemetry to better understand customer needs.

        You can OPT OUT and disable telemetry collection by setting the
        environment variable SAM_CLI_TELEMETRY=0 in your shell.
        Thanks for your help!

        Learn More: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-telemetry.html


You can preselect a particular runtime or package type when using the `sam init` experience.
Call `sam init --help` to learn more.

Which template source would you like to use?
        1 - AWS Quick Start Templates
        2 - Custom Template Location
Choice: 1

Choose an AWS Quick Start application template
        1 - Hello World Example
        2 - Data processing
        3 - Hello World Example with Powertools for AWS Lambda
        4 - Multi-step workflow
        5 - Scheduled task
        6 - Standalone function
        7 - Serverless API
        8 - Infrastructure event management
        9 - Lambda Response Streaming
        10 - Serverless Connector Hello World Example
        11 - Multi-step workflow with Connectors
        12 - GraphQLApi Hello World Example
        13 - Full Stack
        14 - Lambda EFS example
        15 - Hello World Example With Powertools for AWS Lambda
        16 - DynamoDB Example
        17 - Machine Learning
Template: 1

Use the most popular runtime and package type? (Python and zip) [y/N]: y

Would you like to enable X-Ray tracing on the function(s) in your application?  [y/N]: N

Would you like to enable monitoring using CloudWatch Application Insights?
For more info, please view https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch-application-insights.html [y/N]: N

Project name [sam-app]: 
                                                                                                                                                                                                                                                                                         
Cloning from https://github.com/aws/aws-sam-cli-app-templates (process may take a moment)                                                                                                                                                                                                

    -----------------------
    Generating application:
    -----------------------
    Name: sam-app
    Runtime: python3.9
    Architectures: x86_64
    Dependency Manager: pip
    Application Template: hello-world
    Output Directory: .
    Configuration file: sam-app/samconfig.toml
    
    Next steps can be found in the README file at sam-app/README.md
        

Commands you can use next
=========================
[*] Create pipeline: cd sam-app && sam pipeline init --bootstrap
[*] Validate SAM template: cd sam-app && sam validate
[*] Test Function in the Cloud: cd sam-app && sam sync --stack-name {stack-name} --watch


SAM CLI update available (1.103.0); (1.97.0 installed)
To download: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html
[cloudshell-user@ip-10-6-60-46 ~]$ 
```
## Verification
```
[cloudshell-user@ip-10-6-60-46 ~]$ ll
total 8
drwxrwxr-x 3 cloudshell-user cloudshell-user 4096 Nov 23 17:54 s3-module
drwxrwxr-x 5 cloudshell-user cloudshell-user 4096 Nov 27 17:26 sam-app

[cloudshell-user@ip-10-6-60-46 ~]$ cd sam-app/

[cloudshell-user@ip-10-6-60-46 sam-app]$ ll
total 32
drwxrwxr-x 2 cloudshell-user cloudshell-user 4096 Nov 27 17:26 events
drwxrwxr-x 2 cloudshell-user cloudshell-user 4096 Nov 27 17:26 hello_world
-rw-rw-r-- 1 cloudshell-user cloudshell-user    0 Nov 27 17:26 __init__.py
-rw-rw-r-- 1 cloudshell-user cloudshell-user 8329 Nov 27 17:26 README.md
-rw-rw-r-- 1 cloudshell-user cloudshell-user  679 Nov 27 17:26 samconfig.toml
-rw-rw-r-- 1 cloudshell-user cloudshell-user 1681 Nov 27 17:26 template.yaml
drwxrwxr-x 4 cloudshell-user cloudshell-user 4096 Nov 27 17:26 tests

[cloudshell-user@ip-10-6-60-46 sam-app]$ ls hello_world/
app.py  __init__.py  requirements.txt
```

# Build
## Install SAM CLI
```
[cloudshell-user@ip-10-6-60-46 sam-app]$cd

[cloudshell-user@ip-10-6-60-46 ~]$ wget https://github.com/aws/aws-sam-cli/releases/latest/download/aws-sam-cli-linux-x86_64.zip

[cloudshell-user@ip-10-6-60-46 ~]$ unzip aws-sam-cli-linux-x86_64.zip -d sam-installation

[cloudshell-user@ip-10-6-60-46 ~]$ sudo ./sam-installation/install

[cloudshell-user@ip-10-6-60-46 ~]$  sam --version
SAM CLI, version 1.103.0
```
## Install python 3.9
```
[cloudshell-user@ip-10-6-60-46]$ sudo yum install gcc openssl-devel bzip2-devel libffi-devel

[cloudshell-user@ip-10-6-60-46]$ wget https://www.python.org/ftp/python/3.9.18/Python-3.9.18.tgz

[cloudshell-user@ip-10-6-60-46]$ [cloudshell-user@ip-10-6-60-46 ~]$ cd Python-3.9.18

[cloudshell-user@ip-10-6-60-46 Python-3.9.18]$ ls
aclocal.m4  CODE_OF_CONDUCT.md  config.guess  config.sub  configure  configure.ac  Doc  Grammar  Include  install-sh  Lib  LICENSE  Mac  Makefile.pre.in  Misc  Modules  netlify.toml  Objects  Parser  PC  PCbuild  Programs  pyconfig.h.in  Python  README.rst  setup.py  Tools

[cloudshell-user@ip-10-6-60-46 Python-3.9.18]$ ./configure --enable-optimizations
[cloudshell-user@ip-10-6-60-46 Python-3.9.18]$ sudo make altinstall
sudo ln -s  /home/cloudshell-user/Python-3.9.18/python /usr/bin/python3
```
## Launch build
```
[cloudshell-user@ip-10-6-60-46 Python-3.9.18]$ cd ../sam-app/

[cloudshell-user@ip-10-6-60-46 sam-app]$ sam build
Starting Build use cache                                                                                                                                                                                                                                                                 
Manifest file is changed (new hash: 3298f13049d19cffaa37ca931dd4d421) or dependency folder (.aws-sam/deps/7a668c8b-0f01-44fb-abd6-b227a900b02e) is missing for (HelloWorldFunction), downloading dependencies and copying/building source                                                
Building codeuri: /home/cloudshell-user/sam-app/hello_world runtime: python3.9 metadata: {} architecture: x86_64 functions: HelloWorldFunction                                                                                                                                           
 Running PythonPipBuilder:CleanUp                                                                                                                                                                                                                                                        
 Running PythonPipBuilder:ResolveDependencies                                                                                                                                                                                                                                            
 Running PythonPipBuilder:CopySource                                                                                                                                                                                                                                                     
 Running PythonPipBuilder:CopySource                                                                                                                                                                                                                                                     

Build Succeeded

Built Artifacts  : .aws-sam/build
Built Template   : .aws-sam/build/template.yaml

Commands you can use next
=========================
[*] Validate SAM template: sam validate
[*] Invoke Function: sam local invoke
[*] Test Function in the Cloud: sam sync --stack-name {{stack-name}} --watch
[*] Deploy: sam deploy --guided
```
# Deploy
```
[cloudshell-user@ip-10-6-60-46 sam-app]$ sam deploy --guided

Configuring SAM deploy
======================

        Looking for config file [samconfig.toml] :  Found
        Reading default arguments  :  Success

        Setting default arguments for 'sam deploy'
        =========================================
        Stack Name [sam-app]: 
        AWS Region [eu-west-3]: 
        #Shows you resources changes to be deployed and require a 'Y' to initiate deploy
        Confirm changes before deploy [Y/n]: y
        #SAM needs permission to be able to create roles to connect to the resources in your template
        Allow SAM CLI IAM role creation [Y/n]: y
        #Preserves the state of previously provisioned resources when an operation fails
        Disable rollback [y/N]: y
        HelloWorldFunction has no authentication. Is this okay? [y/N]: y
        Save arguments to configuration file [Y/n]: y
        SAM configuration file [samconfig.toml]: 
        SAM configuration environment [default]: 

        Looking for resources needed for deployment:
        Creating the required resources...
         Successfully created!

        Managed S3 bucket: aws-sam-cli-managed-default-samclisourcebucket-1095lkpwjmshj
        A different default S3 bucket can be set in samconfig.toml and auto resolution of buckets turned off by setting resolve_s3=False
                                                                                                                                                                                                                                                                                           
        Parameter "stack_name=sam-app" in [default.deploy.parameters] is defined as a global parameter [default.global.parameters].                                                                                                                                                        
        This parameter will be only saved under [default.global.parameters] in /home/cloudshell-user/sam-app/samconfig.toml.                                                                                                                                                               

        Saved arguments to config file
        Running 'sam deploy' for future deployments will use the parameters saved above.
        The above parameters can be changed by modifying samconfig.toml
        Learn more about samconfig.toml syntax at 
        https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-config.html

        Uploading to sam-app/496d6aec2b52d9e5198393d0e1429baf  533732 / 533732  (100.00%)

        Deploying with following values
        ===============================
        Stack name                   : sam-app
        Region                       : eu-west-3
        Confirm changeset            : True
        Disable rollback             : True
        Deployment s3 bucket         : aws-sam-cli-managed-default-samclisourcebucket-1095lkpwjmshj
        Capabilities                 : ["CAPABILITY_IAM"]
        Parameter overrides          : {}
        Signing Profiles             : {}

Initiating deployment
=====================

        Uploading to sam-app/5132dc55dbbb973626e9797abf927184.template  1200 / 1200  (100.00%)


Waiting for changeset to be created..

CloudFormation stack changeset
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Operation                                                             LogicalResourceId                                                     ResourceType                                                          Replacement                                                         
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
+ Add                                                                 HelloWorldFunctionHelloWorldPermissionProd                            AWS::Lambda::Permission                                               N/A                                                                 
+ Add                                                                 HelloWorldFunctionRole                                                AWS::IAM::Role                                                        N/A                                                                 
+ Add                                                                 HelloWorldFunction                                                    AWS::Lambda::Function                                                 N/A                                                                 
+ Add                                                                 ServerlessRestApiDeployment47fc2d5f9d                                 AWS::ApiGateway::Deployment                                           N/A                                                                 
+ Add                                                                 ServerlessRestApiProdStage                                            AWS::ApiGateway::Stage                                                N/A                                                                 
+ Add                                                                 ServerlessRestApi                                                     AWS::ApiGateway::RestApi                                              N/A                                                                 
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Changeset created successfully. arn:aws:cloudformation:eu-west-3:612187453729:changeSet/samcli-deploy1701108429/60a43a91-eb46-48d9-a522-90a7e272687f


```
## Apply Changeset
```
Previewing CloudFormation changeset before deployment
======================================================
Deploy this changeset? [y/N]: y

2023-11-27 18:09:05 - Waiting for stack create/update to complete

CloudFormation events from stack operations (refresh every 5.0 seconds)
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ResourceStatus                                                        ResourceType                                                          LogicalResourceId                                                     ResourceStatusReason                                                
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE_IN_PROGRESS                                                    AWS::CloudFormation::Stack                                            sam-app                                                               User Initiated                                                      
CREATE_IN_PROGRESS                                                    AWS::IAM::Role                                                        HelloWorldFunctionRole                                                -                                                                   
CREATE_IN_PROGRESS                                                    AWS::IAM::Role                                                        HelloWorldFunctionRole                                                Resource creation Initiated                                         
CREATE_COMPLETE                                                       AWS::IAM::Role                                                        HelloWorldFunctionRole                                                -                                                                   
CREATE_IN_PROGRESS                                                    AWS::Lambda::Function                                                 HelloWorldFunction                                                    -                                                                   
CREATE_IN_PROGRESS                                                    AWS::Lambda::Function                                                 HelloWorldFunction                                                    Resource creation Initiated                                         
CREATE_COMPLETE                                                       AWS::Lambda::Function                                                 HelloWorldFunction                                                    -                                                                   
CREATE_IN_PROGRESS                                                    AWS::ApiGateway::RestApi                                              ServerlessRestApi                                                     -                                                                   
CREATE_IN_PROGRESS                                                    AWS::ApiGateway::RestApi                                              ServerlessRestApi                                                     Resource creation Initiated                                         
CREATE_COMPLETE                                                       AWS::ApiGateway::RestApi                                              ServerlessRestApi                                                     -                                                                   
CREATE_IN_PROGRESS                                                    AWS::ApiGateway::Deployment                                           ServerlessRestApiDeployment47fc2d5f9d                                 -                                                                   
CREATE_IN_PROGRESS                                                    AWS::Lambda::Permission                                               HelloWorldFunctionHelloWorldPermissionProd                            -                                                                   
CREATE_IN_PROGRESS                                                    AWS::Lambda::Permission                                               HelloWorldFunctionHelloWorldPermissionProd                            Resource creation Initiated                                         
CREATE_IN_PROGRESS                                                    AWS::ApiGateway::Deployment                                           ServerlessRestApiDeployment47fc2d5f9d                                 Resource creation Initiated                                         
CREATE_COMPLETE                                                       AWS::Lambda::Permission                                               HelloWorldFunctionHelloWorldPermissionProd                            -                                                                   
CREATE_COMPLETE                                                       AWS::ApiGateway::Deployment                                           ServerlessRestApiDeployment47fc2d5f9d                                 -                                                                   
CREATE_IN_PROGRESS                                                    AWS::ApiGateway::Stage                                                ServerlessRestApiProdStage                                            -                                                                   
CREATE_IN_PROGRESS                                                    AWS::ApiGateway::Stage                                                ServerlessRestApiProdStage                                            Resource creation Initiated                                         
CREATE_COMPLETE                                                       AWS::ApiGateway::Stage                                                ServerlessRestApiProdStage                                            -                                                                   
CREATE_COMPLETE                                                       AWS::CloudFormation::Stack                                            sam-app                                                               -                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CloudFormation outputs from deployed stack
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Outputs                                                                                                                                                                                                                                                                              
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Key                 HelloWorldFunctionIamRole                                                                                                                                                                                                                                        
Description         Implicit IAM Role created for Hello World function                                                                                                                                                                                                               
Value               arn:aws:iam::612187453729:role/sam-app-HelloWorldFunctionRole-EtgG042Em4wJ                                                                                                                                                                                       

Key                 HelloWorldApi                                                                                                                                                                                                                                                    
Description         API Gateway endpoint URL for Prod stage for Hello World function                                                                                                                                                                                                 
Value               https://sooeculyki.execute-api.eu-west-3.amazonaws.com/Prod/hello/                                                                                                                                                                                               

Key                 HelloWorldFunction                                                                                                                                                                                                                                               
Description         Hello World Lambda Function ARN                                                                                                                                                                                                                                  
Value               arn:aws:lambda:eu-west-3:612187453729:function:sam-app-HelloWorldFunction-PkMc70t78yQk                                                                                                                                                                           
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Successfully created/updated stack - sam-app in eu-west-3

```
